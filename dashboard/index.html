<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SID - Pump.fun Stream</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --green: #00ff41; --red: #ff4444; --cyan: #00d4ff; --purple: #bf5fff; --bg: #0a0a0a; --card: #111; --border: #222; }
    body { background: var(--bg); color: #fff; font-family: 'JetBrains Mono', monospace; font-size: 14px; }
    
    .container { display: grid; grid-template-columns: 1fr 380px; height: 100vh; }
    
    /* Left: Token Feed */
    .feed { display: flex; flex-direction: column; border-right: 1px solid var(--border); }
    .feed-header { padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .feed-header h1 { font-size: 18px; color: var(--green); }
    .feed-header .live { background: var(--red); color: #fff; padding: 3px 10px; font-size: 11px; border-radius: 3px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .tokens { flex: 1; overflow-y: auto; padding: 10px; }
    .token-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.15s; }
    .token-card:hover { border-color: var(--purple); transform: translateX(3px); }
    .token-card.hot { border-color: var(--green); }
    .token-card.new { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    
    .token-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .token-name { font-weight: bold; font-size: 15px; }
    .token-ticker { color: var(--cyan); }
    .token-mcap { color: var(--green); font-weight: bold; }
    
    .token-mid { display: flex; gap: 15px; font-size: 12px; color: #888; margin-bottom: 8px; }
    .token-mid .up { color: var(--green); }
    .token-mid .down { color: var(--red); }
    
    .token-bottom { display: flex; gap: 10px; }
    .tag { background: #1a1a1a; padding: 3px 8px; border-radius: 3px; font-size: 11px; color: #666; }
    .tag.twitter { color: #1da1f2; }
    .tag.whale { color: var(--green); }
    .tag.dev { color: var(--purple); }
    
    /* Right: Chat */
    .chat { display: flex; flex-direction: column; background: var(--card); }
    .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .chat-header h2 { font-size: 16px; }
    .online { color: var(--green); font-size: 12px; }
    
    .messages { flex: 1; overflow-y: auto; padding: 15px; }
    .message { margin-bottom: 12px; }
    .message .meta { display: flex; gap: 8px; align-items: center; margin-bottom: 4px; }
    .message .user { color: var(--purple); font-weight: bold; font-size: 13px; }
    .message .time { color: #444; font-size: 11px; }
    .message .text { color: #ccc; line-height: 1.4; }
    .message.system { color: #666; font-style: italic; }
    .message.sid .user { color: var(--cyan); }
    .message.sid .text { color: var(--cyan); }
    
    .chat-input { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
    .chat-input input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: #fff; padding: 12px 15px; font-family: inherit; font-size: 14px; border-radius: 5px; outline: none; }
    .chat-input input:focus { border-color: var(--purple); }
    .chat-input button { background: var(--purple); border: none; color: #fff; padding: 12px 20px; font-family: inherit; font-size: 14px; cursor: pointer; border-radius: 5px; }
    .chat-input button:hover { background: #9f3fff; }
    
    /* Mobile */
    @media (max-width: 800px) {
      .container { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
      .feed { border-right: none; border-bottom: 1px solid var(--border); }
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="feed">
      <div class="feed-header">
        <h1>üöÄ pump.fun stream</h1>
        <span class="live">‚óè LIVE</span>
      </div>
      <div class="tokens" id="tokens"></div>
    </div>
    <div class="chat">
      <div class="chat-header">
        <h2>üí¨ Chat</h2>
        <span class="online" id="online">‚óè 0 online</span>
      </div>
      <div class="messages" id="messages"></div>
      <div class="chat-input">
        <input type="text" id="input" placeholder="Say something..." autocomplete="off">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script>
// Config - use current tunnel
const SID_URL = window.location.hostname.includes('vercel') 
  ? 'https://travels-eastern-gmbh-chris.trycloudflare.com'
  : '';
const AUTH_TOKEN = 'sid2026';

// State
let username = 'anon_' + Math.random().toString(36).slice(2, 6);
let tokens = [];
let onlineCount = 1;

// DOM
const tokensEl = document.getElementById('tokens');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const onlineEl = document.getElementById('online');

// Format helpers
function formatMcap(mcap) {
  if (mcap >= 1000000) return '$' + (mcap / 1000000).toFixed(2) + 'M';
  if (mcap >= 1000) return '$' + (mcap / 1000).toFixed(1) + 'K';
  return '$' + mcap.toFixed(0);
}

function formatTime(date) {
  return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// Render token card
function renderToken(token, isNew = false) {
  const change = token.change5m || 0;
  const changeClass = change >= 0 ? 'up' : 'down';
  const changeStr = (change >= 0 ? '+' : '') + change.toFixed(1) + '%';
  
  const tags = [];
  if (token.twitter) tags.push('<span class="tag twitter">ùïè linked</span>');
  if (token.whales && token.whales > 0) tags.push(`<span class="tag whale">üêã ${token.whales}</span>`);
  if (token.devHolding < 5) tags.push('<span class="tag dev">dev &lt;5%</span>');
  
  const isHot = token.score >= 60 || change > 20;
  
  return `
    <div class="token-card ${isHot ? 'hot' : ''} ${isNew ? 'new' : ''}" onclick="selectToken('${token.mint}')">
      <div class="token-top">
        <span class="token-name">${token.name || 'Unknown'} <span class="token-ticker">$${token.symbol || '???'}</span></span>
        <span class="token-mcap">${formatMcap(token.mcap || 0)}</span>
      </div>
      <div class="token-mid">
        <span>Score: ${token.score || 0}</span>
        <span class="${changeClass}">5m: ${changeStr}</span>
        <span>Buys: ${token.buyRatio || 50}%</span>
      </div>
      <div class="token-bottom">${tags.join('')}</div>
    </div>
  `;
}

function updateTokens() {
  tokensEl.innerHTML = tokens.slice(0, 30).map((t, i) => renderToken(t, i === 0 && t._new)).join('');
}

function selectToken(mint) {
  const token = tokens.find(t => t.mint === mint);
  if (token) {
    addMessage('system', `üìä ${token.name} ($${token.symbol}) - MC: ${formatMcap(token.mcap)}`);
    // Could open detail panel here
  }
}

// Chat
function addMessage(type, text, user = 'system') {
  const msg = document.createElement('div');
  msg.className = `message ${type}`;
  
  if (type === 'system') {
    msg.innerHTML = text;
  } else {
    msg.innerHTML = `
      <div class="meta">
        <span class="user">${user}</span>
        <span class="time">${formatTime(new Date())}</span>
      </div>
      <div class="text">${text}</div>
    `;
  }
  
  messagesEl.appendChild(msg);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  // Keep only last 100 messages
  while (messagesEl.children.length > 100) {
    messagesEl.removeChild(messagesEl.firstChild);
  }
}

async function sendMessage() {
  const text = inputEl.value.trim();
  if (!text) return;
  
  inputEl.value = '';
  addMessage('user', text, username);
  
  // Send to server
  try {
    await fetch(`${SID_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user: username, text, token: AUTH_TOKEN })
    });
  } catch (e) {
    // Local mode
  }
}

inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendMessage();
});

// SSE Connection
function connect() {
  const es = new EventSource(`${SID_URL}/events`);
  
  es.onopen = () => {
    addMessage('system', 'üü¢ Connected to stream');
  };
  
  es.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      
      if (data.type === 'token') {
        // New token from scanner
        const existing = tokens.findIndex(t => t.mint === data.token.mint);
        if (existing >= 0) {
          tokens[existing] = { ...tokens[existing], ...data.token };
        } else {
          data.token._new = true;
          tokens.unshift(data.token);
          setTimeout(() => { data.token._new = false; }, 1000);
        }
        updateTokens();
      }
      
      if (data.type === 'chat') {
        addMessage(data.from === 'SID' ? 'sid' : 'user', data.text, data.from);
      }
      
      if (data.type === 'online') {
        onlineCount = data.count;
        onlineEl.textContent = `‚óè ${onlineCount} online`;
      }
      
      if (data.type === 'speak') {
        addMessage('sid', data.text, 'ü¶û SID');
      }
      
    } catch (e) {}
  };
  
  es.onerror = () => {
    addMessage('system', 'üî¥ Disconnected, reconnecting...');
    es.close();
    setTimeout(connect, 3000);
  };
}

// Mock tokens for demo (will be replaced by real scanner data)
function mockTokens() {
  const names = ['PEPE2', 'WOJAK', 'DOGE420', 'MOONCAT', 'GIGACHAD', 'BASED', 'COPE', 'FREN'];
  const syms = ['PEPE2', 'WOJ', 'D420', 'MCAT', 'GIGA', 'BASED', 'COPE', 'FREN'];
  
  for (let i = 0; i < 8; i++) {
    tokens.push({
      mint: 'mock_' + i,
      name: names[i],
      symbol: syms[i],
      mcap: Math.random() * 100000 + 10000,
      score: Math.floor(Math.random() * 40) + 40,
      change5m: (Math.random() - 0.4) * 50,
      buyRatio: Math.floor(Math.random() * 30) + 40,
      twitter: Math.random() > 0.7,
      whales: Math.floor(Math.random() * 3),
      devHolding: Math.random() * 15
    });
  }
  updateTokens();
}

// Init
addMessage('system', 'üöÄ SID Pump Stream v1.0');
addMessage('system', 'üëÄ Watching pump.fun for new tokens...');
mockTokens();
connect();

// Prompt for username
setTimeout(() => {
  const name = prompt('Enter your name:', username);
  if (name && name.trim()) {
    username = name.trim().slice(0, 16);
    addMessage('system', `Welcome, ${username}! üëã`);
  }
}, 500);
  </script>
</body>
</html>
